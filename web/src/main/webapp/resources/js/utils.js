var app = app || {};

app.tpl = {
    // Hash of preloaded templates for the app
    templates: {},
    // Recursively pre-load all the templates for the app.
    // This implementation should be changed in a production environment. All the template files should be
    // concatenated in a single file.
    loadTemplates: function (names, callback) {

        var that = this;

        var loadTemplate = function (index) {
            var name = names[index];
            $.get('resources/templates/' + name + '.html', function (data) {
                that.templates[name] = data;
                index++;
                if (index < names.length) {
                    loadTemplate(index);
                } else {
                    callback();
                }
            });
        }

        loadTemplate(0);
    },
    // Get template by name from hash of preloaded templates
    get: function (name) {
        return this.templates[name];
    }

};

app.timeConverter = function (UNIX_timestamp) {
    var a = new Date(UNIX_timestamp);
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var year = a.getFullYear();
    var month = months[a.getMonth()];
    var date = a.getDate() < 10 ? '0' + a.getDate() : a.getDate();
    var hour = a.getHours() < 10 ? '0' + a.getHours() : a.getHours();
    var min = a.getMinutes() < 10 ? '0' + a.getMinutes() : a.getMinutes();
    var sec = a.getSeconds() < 10 ? '0' + a.getSeconds() : a.getSeconds();
    var time = date + '-' + month + '-' + year + ' ' + hour + ':' + min + ':' + sec;
    return time;
};

app.getChartDataAndDraw = function (truckNo, container) {
//    var data = [
//        [1147651200000, 67.37, 68.38, 67.12, 67.79, 18921051],
//        [1147737600000, 68.10, 68.25, 64.75, 64.98, 33470860],
//        [1147824000000, 64.70, 65.70, 64.07, 65.26, 26941146],
//        [1147910400000, 65.68, 66.26, 63.12, 63.18, 23524811],
//        [1147996800000, 63.26, 64.88, 62.82, 64.51, 35221586],
//        [1148256000000, 63.87, 63.99, 62.77, 63.38, 25680800],
//        [1148342400000, 64.86, 65.19, 63.00, 63.15, 24814061],
//        [1148428800000, 62.99, 63.65, 61.56, 63.34, 32722949],
//        [1148515200000, 64.26, 64.45, 63.29, 64.33, 16563319],
//        [1148601600000, 64.31, 64.56, 63.14, 63.55, 15464811],
//        [1148947200000, 63.29, 63.30, 61.22, 61.22, 20125338],
//        [1149033600000, 61.76, 61.79, 58.69, 59.77, 45755325],
//        /* Jun 2006 */
//        [1149120000000, 59.85, 62.28, 59.52, 62.17, 33669043],
//        [1149206400000, 62.43, 63.10, 60.88, 61.66, 24496720],
//        [1149465600000, 61.15, 61.15, 59.97, 60.00, 21639826],
//        [1149552000000, 60.22, 60.63, 58.91, 59.72, 25933308],
//        [1149638400000, 60.10, 60.40, 58.35, 58.56, 26813938],
//        [1149724800000, 58.44, 60.93, 57.15, 60.76, 49911361],
//        [1149811200000, 61.18, 61.56, 59.10, 59.24, 27712815],
//        [1150070400000, 59.40, 59.73, 56.96, 57.00, 25642234],
//        [1150156800000, 57.61, 59.10, 57.36, 58.33, 38605066],
//        [1150243200000, 58.28, 58.78, 56.69, 57.61, 31371508],
//        [1150329600000, 57.30, 59.74, 56.75, 59.38, 42519228],
//        [1150416000000, 58.96, 59.19, 57.52, 57.56, 29939223],
//        [1150675200000, 57.83, 58.18, 57.00, 57.20, 25773905],
//        [1150761600000, 57.61, 58.35, 57.29, 57.47, 24036581],
//        [1150848000000, 57.74, 58.71, 57.30, 57.86, 30856077],
//        [1150934400000, 58.20, 59.75, 58.07, 59.58, 34551392],
//        [1151020800000, 59.72, 60.17, 58.73, 58.83, 23578607],
//        [1151280000000, 59.17, 59.20, 58.37, 58.99, 16661904],
//        [1151366400000, 59.09, 59.22, 57.40, 57.43, 19665400],
//        [1151452800000, 57.29, 57.30, 55.41, 56.02, 30395258],
//        [1151539200000, 56.76, 59.09, 56.39, 58.97, 31258941],
//        [1151625600000, 57.59, 57.75, 56.50, 57.27, 26451164],
//        /* Jul 2006 */
//        [1151884800000, 57.52, 58.18, 57.34, 57.95, 6956169],
//        [1152057600000, 57.15, 57.60, 56.56, 57.00, 18530216],
//        [1152144000000, 57.09, 57.40, 55.61, 55.77, 22620152],
//        [1152230400000, 55.48, 56.55, 54.67, 55.40, 28549502],
//        [1152489600000, 55.70, 56.49, 54.50, 55.00, 18971433],
//        [1152576000000, 55.11, 55.99, 54.53, 55.65, 29477035],
//        [1152662400000, 55.17, 55.24, 52.92, 52.96, 33118840],
//        [1152748800000, 52.03, 54.12, 51.41, 52.25, 44639492],
//        [1152835200000, 52.50, 52.89, 50.16, 50.67, 35465535],
//        [1153094400000, 51.73, 53.11, 51.65, 52.37, 36594798],
//        [1153180800000, 53.16, 53.85, 51.85, 52.90, 35755729],
//        [1153267200000, 52.96, 55.08, 52.36, 54.10, 50133874],
//        [1153353600000, 60.99, 61.59, 59.72, 60.50, 70446830],
//        [1153440000000, 59.82, 61.15, 59.64, 60.72, 31860034],
//        [1153699200000, 61.26, 62.10, 60.43, 61.42, 25821004],
//        [1153785600000, 61.78, 62.09, 60.78, 61.93, 21045822],
//        [1153872000000, 62.00, 64.64, 61.68, 63.87, 32093907],
//        [1153958400000, 64.50, 65.02, 62.86, 63.40, 26253218],
//        [1154044800000, 63.94, 65.68, 63.50, 65.59, 24701342],
//        [1154304000000, 66.83, 68.63, 66.28, 67.96, 31896633],
//        /* Aug 2006 */
//        [1154390400000, 67.20, 67.93, 65.94, 67.18, 25422342],
//        [1154476800000, 67.65, 68.68, 67.51, 68.16, 19676548],
//        [1154563200000, 67.91, 70.00, 67.81, 69.59, 30050087],
//        [1154649600000, 67.05, 68.61, 64.96, 68.30, 66185563],
//        [1154908800000, 67.72, 69.60, 66.31, 67.21, 44860684],
//        [1154995200000, 67.09, 67.11, 64.51, 64.78, 35639691],
//        [1155081600000, 65.49, 65.60, 63.40, 63.59, 34144146],
//        [1155168000000, 63.15, 64.81, 62.70, 64.07, 24922555],
//        [1155254400000, 63.24, 64.13, 62.58, 63.65, 27769040],
//        [1155513600000, 64.05, 65.22, 63.60, 63.94, 25630849],
//        [1155600000000, 65.34, 66.50, 64.80, 66.45, 30776194],
//        [1155686400000, 67.10, 68.07, 66.33, 67.98, 27910573],
//        [1155772800000, 68.00, 68.66, 67.18, 67.59, 20755486],
//        [1155859200000, 67.71, 68.40, 67.26, 67.91, 19155769],
//        [1156118400000, 67.30, 67.31, 66.15, 66.56, 18799894],
//        [1156204800000, 66.68, 68.32, 66.50, 67.62, 20614765],
//        [1156291200000, 68.00, 68.65, 66.94, 67.31, 19159786],
//        [1156377600000, 67.89, 68.19, 66.27, 67.81, 23401393],
//        [1156464000000, 67.34, 69.05, 67.31, 68.75, 19442399],
//        [1156723200000, 68.50, 68.61, 66.68, 66.98, 26365385],
//        [1156809600000, 66.99, 67.26, 65.12, 66.48, 33839847],
//        [1156896000000, 67.34, 67.82, 66.68, 66.96, 24295394],
//        [1156982400000, 67.28, 68.30, 66.66, 67.85, 20528728],
//        /* Sep 2006 */
//        [1157068800000, 68.48, 68.65, 67.82, 68.38, 14593768],
//        [1157414400000, 68.97, 71.50, 68.55, 71.48, 36185360],
//        [1157500800000, 71.08, 71.69, 69.70, 70.03, 34793523],
//        [1157587200000, 70.60, 73.48, 70.25, 72.80, 45286595],
//        [1157673600000, 73.37, 73.57, 71.91, 72.52, 32003516],
//        [1157932800000, 72.43, 73.73, 71.42, 72.50, 33899923],
//        [1158019200000, 72.81, 73.45, 71.45, 72.63, 60194956],
//        [1158105600000, 72.85, 74.32, 72.30, 74.20, 40939698],
//        [1158192000000, 73.72, 74.67, 73.46, 74.17, 28655437],
//        [1158278400000, 74.60, 74.98, 73.29, 74.10, 35118880],
//        [1158537600000, 73.80, 74.86, 73.30, 73.89, 25190372],
//        [1158624000000, 74.10, 74.36, 72.80, 73.77, 25360678],
//        [1158710400000, 74.38, 75.68, 74.22, 75.26, 29393060],
//        [1158796800000, 75.25, 76.06, 74.02, 74.65, 28365486],
//        [1158883200000, 74.30, 74.34, 72.58, 73.00, 23778485],
//        [1159142400000, 73.81, 75.86, 73.72, 75.75, 30710124],
//        [1159228800000, 76.18, 77.78, 76.10, 77.61, 39670343],
//        [1159315200000, 77.17, 77.47, 75.82, 76.41, 28996626],
//        [1159401600000, 77.02, 77.48, 75.95, 77.01, 25862827],
//        [1159488000000, 77.11, 77.52, 76.68, 76.98, 14497437]
//    ];
    var data;
    $.ajax({
        type: 'GET',
        url: 'logs/graph?truckNo=' + truckNo,
        success: function (response) {
            if (response.graphData)
                data = response.graphData;
            app.drawTruckRecentInfoChart(data, container);
        }
    });
};

app.drawTruckRecentInfoChart = function (data, container) {
    //get data for chart...
//    console.warn(data);
    var
            i = 0, data0 = [], data1 = [], data2 = [], data3 = [],
            // set the allowed units for data grouping
            dataLength = data.length;
    for (i; i < dataLength; i += 1) {
        data0.push([
            parseFloat(data[i][0], 10), // the date
            parseFloat(data[i][1], 10) // speed
        ]);
        data1.push([
            parseFloat(data[i][0], 10), // the date
            parseFloat(data[i][2], 10) // Slump
        ]);
        data2.push([
            parseFloat(data[i][0], 10), // the date
            parseFloat(data[i][3], 10) // Volume
        ]);
        data3.push([
            parseFloat(data[i][0], 10), // the date
            parseFloat(data[i][4], 10) // tempProbe
        ]);
    }
//    console.warn(data1);
    // create the chart
    $(container).highcharts('StockChart', {
        chart: {
            events: {
                load: function () {
                    // set up the updating of the chart each second
                    $.each(this.series, function (i, series) {
//                                console.warn(series);
                    });
                }
            },
            height: '500',
            backgroundColor: 'rgba(0,0,0,0)'
        },
        rangeSelector: {
           enabled: false
        },
        colors: ['#FF0000', '#00FF00', '#0000FF', '#FFFFFF'],
        yAxis: [{
                title: {
                    text: 'Speed'
                },
                height: '22%',
                lineWidth: 2
            }, {
                title: {
                    text: 'Slump'
                },
                top: '25%',
                height: '22%',
                offset: 0,
                startOnTick: false,
                endOnTick: false,
                lineWidth: 2
            }, {
                title: {
                    text: 'Volume'
                },
                top: '50%',
                height: '25%',
                offset: 0,
                startOnTick: false,
                endOnTick: false,
                lineWidth: 2
            }, {
                title: {
                    text: 'Temperature'
                },
                top: '77%',
                height: '22%',
                offset: 0,
                lineWidth: 2
            }],
        series: [{
                type: 'areaspline',
                name: 'Speed',
                id: '111',
                data: data0,
                yAxis: 0
            }
            , {
                type: 'line',
                name: 'Slump',
                data: data1,
                id: '222',
                yAxis: 1
            }, {
                type: 'column',
                name: 'Volume',
                data: data2,
                id: '333',
                yAxis: 2
            },
            {
                type: 'area',
                name: 'Temperature',
                data: data3,
                id: '444',
                yAxis: 3
            }]
    });
};